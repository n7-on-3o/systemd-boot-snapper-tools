#!/bin/bash
# systemd-boot-snapper-tools: snapper-prune-broken

if [[ $EUID -ne 0 ]]; then
   echo "This script must be run as root"
   exit 1
fi

# 1. Handle Retention Argument
KEEP_DAYS=${1:-7}

if ! [[ "$KEEP_DAYS" =~ ^[0-9]+$ ]]; then
    echo "Error: Retention days must be a number."
    echo "Usage: snapper-prune-broken [days_to_retain]"
    exit 1
fi

# 2. Mount Btrfs root using robust discovery
PRUNE_MNT="/run/snapper_prune_mnt"
mkdir -p "$PRUNE_MNT"
ROOT_DEV=$(findmnt -nvo SOURCE / | sed 's/\[.*\]//')

echo "Mounting Btrfs root device ($ROOT_DEV) to $PRUNE_MNT..."
if ! mount "$ROOT_DEV" -o subvolid=5 "$PRUNE_MNT"; then
    echo "Error: Could not mount Btrfs root."
    exit 1
fi

cd "$PRUNE_MNT" || exit 1

echo "--- Searching for broken/archived subvolumes ---"

# 3. Cleanup orphaned snapshot directories
for snap_dir in @snapshots/*; do
    if [[ -d "$snap_dir" && ! -f "$snap_dir/info.xml" ]]; then
        echo "Found orphaned snapshot directory: $snap_dir"
        # Delete nested subvolumes first
        find "$snap_dir" -mindepth 1 -type d -exec btrfs subvolume delete {} + 2>/dev/null
        rm -rf "$snap_dir"
        echo "Done: Cleared orphaned directory $snap_dir"
    fi
done

# 4. Cleanup archived rollbacks
if [[ "$KEEP_DAYS" -eq 0 ]]; then
    echo "Retention set to 0: Locating ALL rollback backups..."
    FIND_CMD=(find . -maxdepth 1 -name "@_backup_*" -type d)
else
    echo "Locating rollback backups older than $KEEP_DAYS days..."
    FIND_CMD=(find . -maxdepth 1 -name "@_backup_*" -type d -mtime +"$KEEP_DAYS")
fi

# Execute the search and prune with verbose output
"${FIND_CMD[@]}" | while read -r backup; do
    echo "Targeting backup: $backup"
    if btrfs subvolume delete "$backup" 2>/dev/null || rm -rf "$backup"; then
        echo "Successfully pruned: $backup"
    else
        echo "Failed to prune: $backup"
    fi
done

# 5. Cleanup
cd /
umount "$PRUNE_MNT"
rmdir "$PRUNE_MNT"

echo "--- Pruning Complete ---"
